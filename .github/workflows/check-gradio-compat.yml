name: Check Gradio Compatibility

on:
  schedule:
    - cron: '0 0 * * 1'  # 매주 월요일 자정 실행
  workflow_dispatch:      # 수동 실행 가능

jobs:
  check-dependency-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install latest dependencies
        run: |
          pip install --upgrade pip
          # 최신 버전의 gradio와 huggingface-hub 설치 (버전 고정 없이)
          pip install gradio huggingface-hub

      - name: Verify Import
        id: verify_import
        continue-on-error: true
        run: |
          python -c "import gradio; print('Successfully imported gradio with latest huggingface-hub')" && echo "success=true" >> $GITHUB_OUTPUT || echo "success=false" >> $GITHUB_OUTPUT

      - name: Remove workaround from deploy script
        if: steps.verify_import.outputs.success == 'true'
        run: |
          # deploy-space.yml에서 huggingface-hub 버전 고정 관련 sed 명령 주석 처리 또는 제거
          # 여기서는 sed 명령이 있는 줄들을 삭제합니다.
          sed -i '/huggingface-hub 버전 강제 다운그레이드/d' .github/workflows/deploy-space.yml
          sed -i '/lock 파일의 버전을 무시하고 호환 버전으로 교체/d' .github/workflows/deploy-space.yml
          sed -i "/sed -i 's\/\^huggingface-hub==.\*\/huggingface-hub<0.25.0\/'/d" .github/workflows/deploy-space.yml

      - name: Create Pull Request
        if: steps.verify_import.outputs.success == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(ci): remove checking for HfFolder compatibility workaround"
          title: "chore: Remove huggingface-hub version pin workaround"
          body: |
            ## Dependency Compatibility Check
            
            This PR was automatically created because the compatibility check script detected that `gradio` and the latest `huggingface-hub` are now working together correctly.
            
            The `ImportError: cannot import name 'HfFolder'` issue appears to be resolved in the latest versions.
            
            **Changes:**
            - Removed the `sed` hack in `.github/workflows/deploy-space.yml` that pinned `huggingface-hub<0.25.0`.
            
            Please verify manually before merging.
          branch: chore/remove-dependency-workaround
          delete-branch: true
