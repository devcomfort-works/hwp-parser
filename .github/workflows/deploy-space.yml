name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Prepare deployment directory
        run: |
          mkdir deploy_dist
          
          # 1. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (íŒ¨í‚¤ì§€ êµ¬ì¡° ë³€ê²½)
          # src/hwp_parserë¥¼ ë£¨íŠ¸ì˜ hwp_parserë¡œ ë³µì‚¬í•˜ì—¬ ì„¤ì¹˜ ì—†ì´ import ê°€ëŠ¥í•˜ê²Œ í•¨
          cp -r src/hwp_parser deploy_dist/hwp_parser
          
          # 2. app.py ë°°ì¹˜
          cp src/hwp_parser/web/app.py deploy_dist/app.py
          
          # 3. requirements.txt ìƒì„± (Rye lock íŒŒì¼ ê¸°ë°˜)
          # requirements.lockì„ ì‚¬ìš©í•˜ì—¬ ê°œë°œ í™˜ê²½ê³¼ ë™ì¼í•œ ë²„ì „ ë³´ì¥
          cp requirements.lock deploy_dist/requirements.txt
          
          # -e file:. (í˜„ì¬ íŒ¨í‚¤ì§€ ì„¤ì¹˜) ë¼ì¸ ì œê±°
          sed -i '/^-e file:./d' deploy_dist/requirements.txt
          
          # 4. Space ì „ìš© README.md ìƒì„±
          echo "---" > deploy_dist/README.md
          echo "title: HWP Parser" >> deploy_dist/README.md
          echo "emoji: ğŸ“„" >> deploy_dist/README.md
          echo "colorFrom: blue" >> deploy_dist/README.md
          echo "colorTo: indigo" >> deploy_dist/README.md
          echo "sdk: gradio" >> deploy_dist/README.md
          echo "sdk_version: 4.16.0" >> deploy_dist/README.md
          echo "app_file: app.py" >> deploy_dist/README.md
          echo "pinned: false" >> deploy_dist/README.md
          echo "---" >> deploy_dist/README.md
          echo "" >> deploy_dist/README.md
          # ì›ë³¸ README ë‚´ìš© ì´ì–´ë¶™ì´ê¸°
          cat README.md >> deploy_dist/README.md

      - name: Push to Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cd deploy_dist
          git init
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add .
          git commit -m "Deploy from GitHub Actions: ${{ github.sha }}"
          
          # HEAD:main ë¬¸ë²•ì„ ì‚¬ìš©í•˜ì—¬ ë¡œì»¬ ë¸Œëœì¹˜ ì´ë¦„(master/main)ì— ìƒê´€ì—†ì´ 
          # ë¦¬ëª¨íŠ¸ì˜ 'main' ë¸Œëœì¹˜ë¡œ ê°•ì œ í‘¸ì‹œí•©ë‹ˆë‹¤.
          # ë‹¤ë¥¸ ë¸Œëœì¹˜ë¡œ ë°°í¬í•˜ë ¤ë©´ ë’¤ì˜ 'main'ì„ 'gh-pages' ë“±ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.
          git push --force https://devcomfort:$HF_TOKEN@huggingface.co/spaces/devcomfort/hwp-parser HEAD:main
